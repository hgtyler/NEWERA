<style>
  .recently-viewed-products {
    text-align: center;
    margin: 20px 0;
  }
  
  .recently-viewed-products h2 {
    font-size: 24px;
    margin-bottom: 10px;
  }
  
  .recently-viewed-products .grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .recently-viewed-products .grid__item {
    width: 22%;
    margin: 1%;
    box-sizing: border-box;
  }
  
  .card-product {
    padding: 10px;
    text-align: center;
  }
  
  .card-product__image-wrapper {
    display: block;
    margin: 0 auto 10px;
  }
  
  .card-product__image {
    width: 100%;
    height: auto;
  }
  
  .card-product__info {
    text-align: center;
  }
  
  .card-product__title {
    font-size: 13px;
    display: block;
    color: #561C24;
    text-decoration: none;
  }
  .card-product__title:hover {
    text-decoration: underline;
  }
  
  .card-product__price {
    font-size: 13px;
    color: #561C24;
  }
  </style>
  
  <div class="recently-viewed-products">
    <h2>{{ section.settings.section_title }}</h2>
    <ul class="grid" id="recently-viewed-container"></ul>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var container = document.getElementById('recently-viewed-container');
      var recentlyViewedProducts = JSON.parse(localStorage.getItem('recentlyViewedProducts')) || [];
      var maxProducts = {{ section.settings.max_products }};
  
      console.log('Recently viewed products:', recentlyViewedProducts); // Debugging line
  
      recentlyViewedProducts.slice(-maxProducts).forEach(function(productHandle) {
        fetch('/products/' + productHandle + '.js').then(function(response) {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Network response was not ok for product: ' + productHandle);
          }
        }).then(function(product) {
          console.log('Fetched product:', product); // Debugging line
  
          if (product) {
            var productHtml = `
              <li class="grid__item">
                <div class="card-product">
                  <a href="/products/${product.handle}" class="card-product__image-wrapper">
                    <img src="${product.featured_image}" alt="${product.title}" class="card-product__image">
                  </a>
                  <div class="card-product__info">
                    <a href="/products/${product.handle}" class="card-product__title">${product.title}</a>
                    <div class="card-product__price">
                      ${product.price ? `$${(product.price / 100).toFixed(2)}` : 'Price not available'}
                    </div>
                  </div>
                </div>
              </li>
            `;
            container.insertAdjacentHTML('beforeend', productHtml);
          } else {
            console.error('Product data is not valid:', product);
          }
        }).catch(function(error) {
          console.error('Error fetching product:', productHandle, error);
        });
      });
    });
  </script>
  
  {% schema %}
  {
    "name": "Recently Viewed Products",
    "settings": [
      {
        "type": "number",
        "id": "max_products",
        "label": "Maximum number of products to show",
        "default": 4
      },
      {
        "type": "text",
        "id": "section_title",
        "label": "Section Title",
        "default": "Recently Viewed"
      }
    ]
  }
  {% endschema %}
  